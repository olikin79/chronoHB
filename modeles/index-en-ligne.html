<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="content-type"><title>Résultats chronoHB en ligne</title>
<link rel="stylesheet" type="text/css" href="mystyleWeb.css"></link>
</head>
<body>

<h1> Choisir l'onglet de la course qui vous intéresse.</h1>
    <div class=tabs >
	@@onglets@@
   </div>


<script src="jquery-3.6.0.js"></script>

<script async>
function MAJ(i) {
	$("#conteneurGlobal" + i.toString()).load("Affichage-tab" + i.toString() + ".html") ;
}


var chronometres = @@heuresDeparts@@;
var timerID = @@timerID@@;//[0,0]; // liste de longueur le nombre d'onglets à afficher.
var startTime = 0 ;
var start = 0 ;
var end = 0 ;
var diff = 0 ;
var dureesActualisation = @@dureesActualisation@@ ; // au début 10 s puis cela varie en fonction du contexte.

function changeTimeZone(date, ianatz) {
  // suppose the date is 12:00 UTC
  var invdate = new Date(date.toLocaleString('en-US', {
    timeZone: ianatz
  }));
  var diff = date.getTime() - invdate.getTime();
  // so 12:00 in Toronto is 17:00 UTC
  return new Date(date.getTime() - diff); // needs to substract
}

function chrono(i){
				start = new Date(chronometres[i][0],chronometres[i][1],chronometres[i][2],chronometres[i][3],chronometres[i][4],chronometres[i][5]);
				end = changeTimeZone(new Date(), 'Europe/London');
                diff = end - start ;
                diff = new Date(diff) ;
                var msec = diff.getMilliseconds() ;
                var sec = diff.getSeconds() ;
                var min = diff.getMinutes() ;
                var hr = diff.getHours()-1 ;
                if (min < 10){
                        min = "0" + min ;
                }
                if (sec < 10){
                        sec = "0" + sec ;
                }
				// A décommenter plus tard pour la production
				//if (start.getDay() == end.getDay() && start.getMonth() == end.getMonth() && start.getYear() == end.getYear()) {
					document.getElementById("chronotime" + i.toString()).innerHTML = "(" + hr + ":" + min + ":" + sec + ")" ;
					timerIDbis = setTimeout("chrono(" + i.toString() + ")", 900) ;
				//} else {
					//document.getElementById("chronotime" + i.toString()).innerHTML = "" ;
				//}
        }
		
function chronoStart(i){
                //clearTimeout(timerID) ;
                //console.debug(chronometres[i][0])
				var idChrono = "chronotime"+ i.toString() ;
                if (chronometres[i][0] == 0) {
                    // c'est une course qui n'a pas commencé
                    document.getElementById(idChrono).innerHTML = "(00:00:00)";
					document.getElementById(idChrono).style.display = "line" ;
                }
                else {
                    if (chronometres[i][0] == 1) {
                        // c'est un challenge
						document.getElementById(idChrono).style.display = "none" ;
                        document.getElementById(idChrono).innerHTML = "";
                    }
                    else {
						//start = changeTimeZone(start, 'UTC');
						//console.debug(idChrono);
						document.getElementById(idChrono).style.display = "line" ;
                        chrono(i);
                    }
                }
        }

function chargerStart(i){
	//console.debug("chargerStart(" + i.toString() + ")=> Affichage-tab"+i.toString()+".html dans #conteneurGlobal"+i.toString());
	let contenuPrecedent = document.getElementById("conteneurGlobal"+i.toString()).textContent ;
	//console.debug(contenuPrecedent);
	$("#conteneurGlobal"+i.toString()).load("Affichage-tab"+i.toString()+".html") ;
	// si c'est une course qui n'a pas commencé (et ce n'est pas un challenge)
	if (chronometres[i][0] == 0) {
		// on double le temps d'actualisation avec un maximum de 2 minutes.
		dureesActualisation[i] = Math.min(120000,dureesActualisation[i]*2);
	} else {
		// la course a commencé, on augmente la fréquence d'actualisation tant que personne n'est arrivé
		console.debug("longueur du contenur:" + document.getElementById("conteneurGlobal"+i.toString()).textContent.length)
		if (document.getElementById("conteneurGlobal"+i.toString()).textContent.length < 2000) {
			// 2000 correspond à environ 50 participants.
			// on actualise fréquemment au début pour les premiers.
			dureesActualisation[i] = Math.max(5000,dureesActualisation[i]/2);
		} else {
			// sinon (si des arrivées), on diminue la fréquence d'actualisation jusqu'à 1 minutes si des changements réguliers.
			// on va jusqu'à 5 min si plus de changement apparent.
			if (contenuPrecedent == document.getElementById("conteneurGlobal"+i.toString()).textContent) { 
				//$("#conteneurGlobal"+i.toString()).innerHTML) {
				// plus de changement depuis la dernière actualisation.
				dureesActualisation[i] = Math.min(120000,dureesActualisation[i]*2);
			} else {
				// encore des changements récents, actualisation dans une minute.
				dureesActualisation[i] = Math.min(60000,dureesActualisation[i]*2);
			}
		}
	}
	console.debug("actualisation de l'onglet Affichage-tab"+i.toString()+".html dans " + dureesActualisation[i]/1000 + "s.");
	// la durée devrait augmenter jusqu'à 5 minutes si la course a commencé et si aucune nouveauté depuis la dernière maj
	// si course commencée et des arrivées régulières, on diminue jusqu'à 
	// elle devrait diminuer jusqu'à 5 secondes si course commencée et pas d'arrivée (pour afficher rapidement le temps du premier, quand disponible.
	// elle doit diminuer jusqu'à 3 min minimum si course non commencée.
	timerID[i] = setTimeout("chargerStart(" + i.toString() + ")", dureesActualisation[i]) ;
}



function lanceTout(){
	var i = 0 ;
	for (var item in chronometres) {
			chargerStart(i)
			chronoStart(i);
			i += 1 ;
		}
	}


lanceTout();

</script>
</body></html>